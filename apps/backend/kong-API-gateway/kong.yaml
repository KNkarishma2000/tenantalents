_format_version: '3.0'

services:
  - name: user-service
    url: http://user-service:3000
    routes:
      - name: user-api
        paths: ['/api/user']
      - name: user-auth
        paths: ['/api/auth']
      - name: user-swagger
        paths: ['/api/docs/user']
        strip_path: false

  - name: product-service
    url: http://product-service:3001
    routes:
      - name: product-api
        paths: ['/api/product']
      - name: product-swagger
        paths: ['/api/docs/product']
        strip_path: false

  - name: order-service
    url: http://order-service:3002
    routes:
      - name: order-api
        paths: ['/api/order']
      - name: order-swagger
        paths: ['/api/docs/order']
        strip_path: false

  - name: cart-service
    url: http://cart-service:3006
    routes:
      - name: cart-api
        paths: ['/api/cart']
      - name: cart-swagger
        paths: ['/api/docs/cart']
        strip_path: false

  - name: email-service
    url: http://email-service:3004
    routes:
      - name: email-api
        paths: ['/api/email']
      - name: email-swagger
        paths: ['/api/docs/email']
        strip_path: false

  - name: payment-service
    url: http://payment-service:3005
    routes:
      - name: payment-api
        paths: ['/api/payment']
      - name: payment-swagger
        paths: ['/api/docs/payment']
        strip_path: false

  - name: invoice-service
    url: http://invoice-service:3010
    routes:
      - name: invoice-api
        paths: ['/api/invoice']
      - name: invoice-swagger
        paths: ['/api/docs/invoice']
        strip_path: false

  - name: analytics-service
    url: http://analytics-service:3011
    routes:
      - name: analytics-api
        paths: ['/api/analytics']
      - name: analytics-swagger
        paths: ['/api/docs/analytics']
        strip_path: false

  - name: rating-service
    url: http://rating-service:3007
    routes:
      - name: rating-api
        paths: ['/api/rating']
      - name: rating-swagger
        paths: ['/api/docs/rating']
        strip_path: false

  - name: search-service
    url: http://search-service:3003
    routes:
      - name: search-api
        paths: ['/api/search']
      - name: search-swagger
        paths: ['/api/docs/search']
        strip_path: false

    plugins:
  - name: cors
    config:
      origins: ['*']
      methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS']
      headers: ['Authorization', 'Content-Type']

  # Example: apply JWT auth only on admin-service routes
  - name: jwt
    service: admin-service
    config:
      key_claim_name: 'iss'
      secret_is_base64: false
      run_on_preflight: false
# üèÉ Running Kong in DB-less Mode
# docker run -d \
#   -e KONG_DATABASE=off \
#   -e KONG_DECLARATIVE_CONFIG=/config/kong.yaml \
#   -v $(pwd)/kong.yaml:/config/kong.yaml:ro \
#   -p 8000:8000 \
#   -p 8001:8001 \
#   kong/kong-gateway:3.5.0.0

# üîÅ Deploying or Updating the Configuration

# You can update your kong.yaml, then reload it via:
# curl -i -X POST http://localhost:8001/config \
#   --data-binary @infra/api-gateway/kong/kong.yaml \
#   -H "Content-Type: application/yaml"

# use decK for sync in CI/CD pipelines:

# deck sync --config kong.yaml
